apiVersion: kubeflow.org/v1
kind: PyTorchJob
metadata:
  name: megatron-pytorchjob
spec:
  pytorchReplicaSpecs:
    Master:
      replicas: 1
      template:
        metadata:
          annotations:
            sidecar.istio.io/inject: "false"
        spec:
          containers:
          - name: pytorch
            image: nvcr.io/nvidia/pytorch:23.06-py3
            imagePullPolicy: IfNotPresent
            command:
            - "/bin/bash"
            - "-c"
            - "cd /mnt/pvc/coreweave-megatron && rm -rf ../checkpoints && ./pretrain_multi_node.sh"
            tty: true
            env:
            - name: GPUS_PER_NODE
              value: "1"
            # Model Config, you can find values here: https://arxiv.org/pdf/2005.14165.pdf
            - name: N_LAYERS
              value: "12"
            - name: D_MODEL
              value: "768"
            - name: N_HEADS
              value: "12"
            - name: M_BS
              value: "1"
            - name: G_BS
              value: "16"
            securityContext:
              runAsUser: 0
            volumeMounts:
              - name: megatron-dev
                mountPath: /mnt/pvc
              - name: dshm
                mountPath: /dev/shm
            resources:
              requests:
                cpu: 32
                memory: 128Gi
                nvidia.com/gpu: 1
              limits:
                cpu: 32
                memory: 128Gi 
                nvidia.com/gpu: 1
          volumes:
            - name: megatron-dev
              persistentVolumeClaim:
                claimName: megatron-dev
            - emptyDir:
                medium: Memory
              name: dshm
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                - matchExpressions:
                  - key: topology.kubernetes.io/region
                    operator: In
                    values: 
                    - LAS1
                  - key: gpu.nvidia.com/class
                    operator: In
                    values:
                    - A40
          restartPolicy: Never
    Worker:
      replicas: 3
      template:
        metadata:
          annotations:
            sidecar.istio.io/inject: "false"
        spec:
          containers:
          - name: pytorch
            image: nvcr.io/nvidia/pytorch:23.06-py3
            imagePullPolicy: IfNotPresent
            command:
            - "/bin/bash"
            - "-c"
            - "cd /mnt/pvc/coreweave-megatron && rm -rf ../checkpoints && ./pretrain_multi_node.sh"
            tty: true
            env:
            - name: GPUS_PER_NODE
              value: "1"
            # Model Config, you can find values here: https://arxiv.org/pdf/2005.14165.pdf
            - name: N_LAYERS
              value: "12"
            - name: D_MODEL
              value: "768"
            - name: N_HEADS
              value: "12"
            - name: M_BS
              value: "1"
            - name: G_BS
              value: "16"
            securityContext:
              runAsUser: 0
            volumeMounts:
              - name: megatron-dev
                mountPath: /mnt/pvc
              - name: dshm
                mountPath: /dev/shm
            resources:
              requests:
                cpu: 32
                memory: 128Gi
                nvidia.com/gpu: 1
              limits:
                cpu: 32
                memory: 128Gi 
                nvidia.com/gpu: 1
          volumes:
            - name: megatron-dev
              persistentVolumeClaim:
                claimName: megatron-dev
            - emptyDir:
                medium: Memory
              name: dshm
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                - matchExpressions:
                  - key: topology.kubernetes.io/region
                    operator: In
                    values: 
                    - LAS1
                  - key: gpu.nvidia.com/class
                    operator: In
                    values:
                    - A40
          restartPolicy: Never
