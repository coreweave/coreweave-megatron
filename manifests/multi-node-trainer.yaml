apiVersion: kubeflow.org/v1
kind: PyTorchJob
metadata:
  name: megatron-pytorchjob
spec:
  pytorchReplicaSpecs:
    Master:
      replicas: 1
      template:
        metadata:
          labels:
            name: megatron-pytorchjob
          annotations:
            sidecar.istio.io/inject: "false"
        spec:
          containers:
            - name: pytorch
              image: nvcr.io/nvidia/pytorch:23.06-py3
              imagePullPolicy: IfNotPresent
              command:
                - "/bin/bash"
                - "-c"
                - >
                  cd /mnt/pvc/coreweave-megatron && 
                  pip3 install tensorizer==2.7.1 && 
                  ./pretrain_multi_node.sh
              tty: true
              env:
                - name: GPUS_PER_NODE
                  value: "1"
                - name: TP_SIZE
                  value: "1"
                - name: PP_SIZE
                  value: "2"
                # Model Config, you can find values here: https://arxiv.org/pdf/2005.14165.pdf
                - name: N_LAYERS
                  value: "32"
                - name: D_MODEL
                  value: "4096"
                - name: N_HEADS
                  value: "32"
                - name: M_BS
                  value: "1"
                - name: G_BS
                  value: "1"
              securityContext:
                runAsUser: 0
              volumeMounts:
                - name: megatron-dev
                  mountPath: /mnt/pvc
                - name: dshm
                  mountPath: /dev/shm
              resources:
                requests:
                  cpu: 32
                  memory: 128Gi
                  ephemeral-storage: 100Gi
                  nvidia.com/gpu: 1
                limits:
                  cpu: 32
                  memory: 128Gi
                  ephemeral-storage: 100Gi
                  nvidia.com/gpu: 1
          volumes:
            - name: megatron-dev
              persistentVolumeClaim:
                claimName: megatron-dev
            - emptyDir:
                medium: Memory
              name: dshm
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: topology.kubernetes.io/region
                        operator: In
                        values: 
                          - LAS1
                      - key: gpu.nvidia.com/class
                        operator: In
                        values:
                          - RTX_A6000
            podAntiAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchExpressions:
                      - key: job-name
                        operator: In
                        values:
                          - megatron-pytorchjob
                  topologyKey: kubernetes.io/hostname
          restartPolicy: Never
    Worker:
      replicas: 1
      template:
        metadata:
          labels:
            name: megatron-pytorchjob
          annotations:
            sidecar.istio.io/inject: "false"
        spec:
          containers:
            - name: pytorch
              image: nvcr.io/nvidia/pytorch:23.06-py3
              imagePullPolicy: IfNotPresent
              command:
                - "/bin/bash"
                - "-c"
                - >
                  cd /mnt/pvc/coreweave-megatron && 
                  pip3 install tensorizer==2.7.1 && 
                  ./pretrain_multi_node.sh
              tty: true
              env:
                - name: GPUS_PER_NODE
                  value: "1"
                - name: TP_SIZE
                  value: "1"
                - name: PP_SIZE
                  value: "2"
                # Model Config, you can find values here: https://arxiv.org/pdf/2005.14165.pdf
                - name: N_LAYERS
                  value: "32"
                - name: D_MODEL
                  value: "4096"
                - name: N_HEADS
                  value: "32"
                - name: M_BS
                  value: "1"
                - name: G_BS
                  value: "1"
              securityContext:
                runAsUser: 0
              volumeMounts:
                - name: megatron-dev
                  mountPath: /mnt/pvc
                - name: dshm
                  mountPath: /dev/shm
              resources:
                requests:
                  cpu: 32
                  memory: 128Gi
                  ephemeral-storage: 100Gi
                  nvidia.com/gpu: 1
                limits:
                  cpu: 32
                  memory: 128Gi
                  ephemeral-storage: 100Gi
                  nvidia.com/gpu: 1
          volumes:
            - name: megatron-dev
              persistentVolumeClaim:
                claimName: megatron-dev
            - emptyDir:
                medium: Memory
              name: dshm
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: topology.kubernetes.io/region
                        operator: In
                        values: 
                          - LAS1
                      - key: gpu.nvidia.com/class
                        operator: In
                        values:
                          - RTX_A6000
            podAntiAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchExpressions:
                      - key: job-name
                        operator: In
                        values:
                          - megatron-pytorchjob
                  topologyKey: kubernetes.io/hostname
          restartPolicy: Never
